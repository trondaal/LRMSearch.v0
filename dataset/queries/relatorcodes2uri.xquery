declare namespace marc="http://www.loc.gov/MARC21/slim";
declare namespace map="http://www.w3.org/2005/xpath-functions/map";

let $codemap := map{
'abr': 'http://rdaregistry.info/Elements/e/object/P20049', (:"abridger"@gden:)
'act': 'http://rdaregistry.info/Elements/e/object/P20012', (:"actor"@gden:)
'adp': 'http://rdaregistry.info/Elements/w/object/P10065', (:"creator"@gden:)
'aft': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'ann': 'http://rdaregistry.info/Elements/e/object/P20021', (:"commentator"@gden:)
'ard': 'http://rdaregistry.info/Elements/w/object/P10065', (:"creator"@gden:)
'arr': 'http://rdaregistry.info/Elements/e/object/P20029', (:"arranger"@gden:)
'art': 'http://rdaregistry.info/Elements/w/object/P10058', (:"artist"@gden:)
'aui': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'aus': 'http://rdaregistry.info/Elements/w/object/P10203', (:"screenplan"@gden:)
'aut': 'http://rdaregistry.info/Elements/w/object/P10061', (:"author"@gden:) 
'bjd': 'http://rdaregistry.info/Elements/m/object/P30069', (:"designer"@gden:)
'bkd': 'http://rdaregistry.info/Elements/m/object/P30069', (:"designer"@gden:)
'clr': 'http://rdaregistry.info/Elements/e/object/P20283', (:"colourist"@gden:)
'cmm': 'http://rdaregistry.info/Elements/e/object/P20021', (:"commentator"@gden:)
'cmp': 'http://rdaregistry.info/Elements/w/object/P10053', (:"composer"@gden:)
'cnd': 'http://rdaregistry.info/Elements/e/object/P20011', (:"conductor"@gden:)
'cng': 'http://rdaregistry.info/Elements/w/object/P10068', (:"cinematographie"@gden:) 
'com': 'http://rdaregistry.info/Elements/w/object/P10055', (:"compiler"@gden:)
'cre': 'http://rdaregistry.info/Elements/w/object/P10065', (:"creator"@gden:)
'ctb': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'ctg': 'http://rdaregistry.info/Elements/m/object/P30315', (:"cartographer"@gden:)
'cwt': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'drt': 'http://rdaregistry.info/Elements/w/object/P10066', (:"director"@gden:)
'dsr': 'http://rdaregistry.info/Elements/m/object/P30069', (:"designer"@gden:)
'edc': 'http://rdaregistry.info/Elements/w/object/P10055', (:"compiler"@gden:)
'edm': 'http://rdaregistry.info/Elements/e/object/P20055', (:"film editor"@gden:)
'edt': 'http://rdaregistry.info/Elements/m/object/P30327', (:"editor"@gden:)
'flm': 'http://rdaregistry.info/Elements/e/object/P20055', (:"film editor"@gden:)
'fmd': 'http://rdaregistry.info/Elements/w/object/P10013', (:"film director"@gden:)
'fmk': 'http://rdaregistry.info/Elements/w/object/P10063', (:"filmmaker"@gden:)
'fmp': 'http://rdaregistry.info/Elements/w/object/P10073', (:"film producer"@gden:)
'hnr': 'http://rdaregistry.info/Elements/w/object/P10049', (:"honouree"@gden:)
'hst': 'http://rdaregistry.info/Elements/e/object/P20016', (:"host"@gden:)
'ill': 'http://rdaregistry.info/Elements/m/object/P30321', (:"illustrator"@gden:)
'itr': 'http://rdaregistry.info/Elements/e/object/P20020', (:"instrumentalist"@gden:)
'ive': 'http://rdaregistry.info/Elements/w/object/P10059', (:"interviewee"@gden:)
'ivr': 'http://rdaregistry.info/Elements/w/object/P10057', (:"interviewer"@gden:)
'lbt': 'http://rdaregistry.info/Elements/w/object/P10205', (:"librettist"@gden:)
'lyr': 'http://rdaregistry.info/Elements/w/object/P10204', (:"lyricist"@gden:)
'msd': 'http://rdaregistry.info/Elements/e/object/P20035', (:"musical director"@gden:)
'mus': 'http://rdaregistry.info/Elements/e/object/P20020', (:"instrumentalist"@gden:)
'nrt': 'http://rdaregistry.info/Elements/e/object/P20022', (:"narrator"@gden:)
'pbl': 'http://rdaregistry.info/Elements/m/object/P30083', (:"publisher"@gden:)
'pht': 'http://rdaregistry.info/Elements/w/object/P10056', (:"photographer"@gden:)
'prd': 'http://rdaregistry.info/Elements/e/object/P20056', (:"production"@gden:) 
'prf': 'http://rdaregistry.info/Elements/e/object/P20039', (:"performer"@gden:)
'prn': 'http://rdaregistry.info/Elements/w/object/P10008', (:"production"@gden:)
'pro': 'http://rdaregistry.info/Elements/w/object/P10064', (:"producer"@gden:)
'prs': 'http://rdaregistry.info/Elements/e/object/P20056', (:"designer"@gden:)
'prt': 'http://rdaregistry.info/Elements/m/object/P30078', (:"printer"@gden:)
'rdd': 'http://rdaregistry.info/Elements/w/object/P10014', (:"radio director"@gden:)
'red': 'http://rdaregistry.info/Elements/m/object/P30327', (:"editor"@gden:)
'rpc': 'http://rdaregistry.info/Elements/w/object/P10074', (:"radio producer"@gden:)
'rsg': 'http://rdaregistry.info/Elements/e/object/P20031', (:"stage director"@gden:)
'sng': 'http://rdaregistry.info/Elements/e/object/P20025', (:"singer"@gden:)
'spk': 'http://rdaregistry.info/Elements/e/object/P20024', (:"speaker"@gden:)
'stl': 'http://rdaregistry.info/Elements/e/object/P20023', (:"storyteller"@gden:)
'tcd': 'http://rdaregistry.info/Elements/e/object/P20364', (:"tecnical director"@gden:)
'trl': 'http://rdaregistry.info/Elements/e/object/P20037', (:"translator"@gden:)
'tyg': 'http://rdaregistry.info/Elements/e/object/P20259', (:"typographer"@gden:)
'vac': 'http://rdaregistry.info/Elements/e/object/P20070', (:"voice actor"@gden:)
'voc': 'http://rdaregistry.info/Elements/e/object/P20025', (:"singer"@gden:)
'wal': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'wat': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'win': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'wpr': 'http://rdaregistry.info/Elements/m/object/P30328', (:"contributor"@gden:)
'wst': 'http://rdaregistry.info/Elements/m/object/P30328'  (:"contributor"@gden:)
}

(: Inserting URI relationship typesfor persons in 100 and 700, check for $t to exclude fields describing works:)
for $code in doc("../xml/cela.xml")//marc:datafield[@tag = ('100','700') and not(marc:subfield/@code='t') ]/marc:subfield[@code='4' and string-length(.) = 3]
let $field := if (map:contains($codemap, $code) and not($codemap($code) = $code/../marc:subfield[@code='4'])) then <marc:subfield code="4" a='t'>{$codemap($code)}</marc:subfield> else  ()
order by $code
(:where (count($code/../marc:subfield[@code='4' and string-length(.) = 3]) = count($code/../marc:subfield[@code='4' and starts-with(., 'http')])):)
return insert node $field after $code